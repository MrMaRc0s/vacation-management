<!DOCTYPE html>
<html>
  <head>
    <title>Manager Dashboard</title>
    <style>
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 6px;
      }
      th {
        background: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h2>Manager Dashboard</h2>

    <h3>Create New User</h3>
    <form id="createUserForm">
      <label>username: <input name="username" required /></label><br />
      <label>Email: <input name="email" type="email" required /></label><br />
      <label>Password: <input name="password" type="password" required /></label
      ><br />
      <label
        >Role:
        <select name="role" required>
          <option value="employee">Employee</option>
          <option value="manager">Manager</option>
        </select> </label
      ><br />
      <label
        >Employee Code:
        <input name="employee_code" pattern="\d{7}" required /></label
      ><br />
      <button type="submit">Create User</button>
    </form>

    <h3>Users</h3>
    <table id="userTable">
      <tr>
        <th>username</th>
        <th>Email</th>
        <th>Employee Code</th>
        <th>Actions</th>
      </tr>
    </table>

    <h3>Vacation Requests</h3>
    <table id="requestTable">
      <tr>
        <th>User ID</th>
        <th>Start</th>
        <th>End</th>
        <th>Reason</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </table>

    <button onclick="logout()" style="float: right">Sign Out</button>

    <script>
      const user = JSON.parse(sessionStorage.getItem("user"));
      if (!user || user.role !== "manager") {
        alert("Access denied.");
        location.href = "/";
      }

      // Fetch and display users
      fetch("/users")
        .then((res) => res.json())
        .then((users) => {
          const table = document.getElementById("userTable");
          users.forEach((u) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td><input value="${u.username}" id="username-${u.id}" /></td>
              <td><input value="${u.email}" id="email-${u.id}" /></td>
              <td>${u.employee_code}</td>
              <td><input placeholder="New password" type="password" id="password-${u.id}" /></td>
              <td>
                <button onclick="updateUser('${u.id}')">Update</button>
                <button onclick="deleteUser('${u.id}')">Delete</button>
              </td>
              `;
            table.appendChild(row);
          });
        });

      // Fetch and display vacation requests
      fetch("/requests/view", {
        method: "POST",
        body: JSON.stringify({ role: "manager" }),
      })
        .then((res) => res.json())
        .then((requests) => {
          const table = document.getElementById("requestTable");
          requests.forEach((r) => {
            const row = document.createElement("tr");
            let actions = "";

            if (r.status === "pending") {
              actions = `
                <button onclick="changeStatus('${r.id}', 'approved')">Approve</button>
                <button onclick="changeStatus('${r.id}', 'rejected')">Reject</button>
              `;
            } else {
              actions = `<button onclick="changeStatus('${r.id}', 'pending')">Cancel</button>`;
            }

            row.innerHTML = `
              <td>${r.user_id}</td>
              <td>${r.start_date}</td>
              <td>${r.end_date}</td>
              <td>${r.reason}</td>
              <td>${r.status}</td>
              <td>${actions}</td>
            `;
            table.appendChild(row);
          });
        });

      // Approve/reject vacation requests
      function changeStatus(requestId, status) {
        fetch("/requests/status", {
          method: "PUT",
          body: JSON.stringify({ request_id: requestId, status }),
        }).then(() => location.reload());
      }

      // Update user info
      function updateUser(userId) {
        const username = document.getElementById(`username-${userId}`).value;
        const email = document.getElementById(`email-${userId}`).value;
        const password = document.getElementById(`password-${userId}`).value;

        const body = { id: userId, username, email };
        if (password.trim()) body.password = password;

        fetch("/users/update", {
          method: "PUT",
          body: JSON.stringify(body),
        }).then(() => alert("User updated"));
      }

      // Delete user
      function deleteUser(userId) {
        if (!confirm("Are you sure you want to delete this user?")) return;
        fetch("/users/delete", {
          method: "DELETE",
          body: JSON.stringify({ id: userId }),
        }).then(() => location.reload());
      }
      document.getElementById("createUserForm").onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;

        const newUser = {
          username: form.username.value,
          email: form.email.value,
          password: form.password.value,
          role: form.role.value,
          employee_code: form.employee_code.value,
        };

        const res = await fetch("/users", {
          method: "POST",
          body: JSON.stringify(newUser),
        });

        if (res.ok) {
          alert("User created!");
          location.reload();
        } else {
          alert("Failed to create user.");
        }
      };
      function logout() {
        sessionStorage.removeItem("user");
        location.href = "/";
      }
    </script>
  </body>
</html>
